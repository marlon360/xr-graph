<html>

<head>
  <title>XR Graph</title>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41295198-4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-41295198-4');
  </script>
</head>

<body>
  <div class="menu-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><linearGradient id="EIPc0qTNCX0EujYwtxKaXa" x1="12.066" x2="34.891" y1=".066" y2="22.891" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#63BFFF"/><stop offset="1" stop-color="#9446FF"/></linearGradient><path fill="url(#EIPc0qTNCX0EujYwtxKaXa)" d="M43,15H5c-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h38c1.1,0,2,0.9,2,2v2C45,14.1,44.1,15,43,15z"/><linearGradient id="EIPc0qTNCX0EujYwtxKaXb" x1="12.066" x2="34.891" y1="12.066" y2="34.891" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#63BFFF"/><stop offset="1" stop-color="#9446FF"/></linearGradient><path fill="url(#EIPc0qTNCX0EujYwtxKaXb)" d="M43,27H5c-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h38c1.1,0,2,0.9,2,2v2C45,26.1,44.1,27,43,27z"/><linearGradient id="EIPc0qTNCX0EujYwtxKaXc" x1="12.066" x2="34.891" y1="24.066" y2="46.891" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#63BFFF"/><stop offset="1" stop-color="#9446FF"/></linearGradient><path fill="url(#EIPc0qTNCX0EujYwtxKaXc)" d="M43,39H5c-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h38c1.1,0,2,0.9,2,2v2C45,38.1,44.1,39,43,39z"/></svg>
  </div>
  <div class="menu closed">
    <div class="menu-inner">
      <h1>XR Graph</h1>
      <h2>Function:</h2>
      <input class="function-input" type="text">
      <div style="display: flex; justify-content: flex-end;">
        <button class="update-button">Update</button>
      </div>
      <p>
        How to write a function:<br>
        Declare parameters with <em>f(u,v)</em><br>
        Declare a vector with square brackets <em>[x,y,z]</em>
      </p>
      <h2>Examples:</h2>
      <div class="examples">
        <a href="?function=f(t)%3D[cos(t),sin(t),t]">f(t)=[cos(t), sin(t), t]</a>
        <a href="?function=f(u,v)%3D[u,v,u*v*0.1]">f(u,v)=[u, v, u*v*0.1]</a>
        <a href="?function=f(u,v)%3D[cos(u),sin(v),2 * cos(v)]">f(u,v)=[cos(u),sin(v),2 * cos(v)]</a>
        <a href="?function=[sin(t)%20+%202%20*%20sin(2*t),%20cos(t)%20-%202%20*%20cos(2*t),%20-sin(3*t)]&tMin=0&tMax=6.3&aMin=0&aMax=3&a=1.5&bMin=0&bMax=3&b=1.5">Trefoil Knot</a>
        <a href="?function=[(a+b*u*cos(0.5*v))*cos(v),%20(a+b*u*cos(0.5*v))*sin(v),%20b*u*sin(0.5*v)]&uMin=-0.5&uMax=0.5&vMin=0&vMax=6.283185307179586&xMin=-1.3231280219206423&xMax=1.8&yMin=-1.6624317662557717&yMax=1.6624317662557717&aMin=1&aMax=2&a=1.5384151615841295&bMin=0.2&bMax=1.5&b=0.9618813442348404">Möbius strip</a>
        <a href="?function=[b%20*%20u%20*%20cos(a%20*%20v),%20b%20*%20u%20*%20sin(a%20*%20v),%200.2%20*%20v]&uMin=-2&uMax=2&vMin=-10&vMax=10&xMin=-2&xMax=2&yMin=-1.9999311713564978&yMax=1.9999311713564978&aMin=0&aMax=1.1&a=0.8800000000000001&bMin=0&bMax=1&b=0.8">Helicoid</a>
        <a href="?function=[cos(u)%20*%20(a%20+%20b%20*%20cos(v)),%20sin(u)%20*%20(a%20+%20b%20*%20cos(v)),%20b%20*%20sin(v)]&uMin=0&uMax=6.283185307179586&vMin=0&vMax=6.283185307179586&xMin=-2&xMax=2&yMin=-2&yMax=2&aMin=0&aMax=2&a=1.3&bMin=0&bMax=1&b=0.3">Torus</a>
      </div>

      <h2>Browser Addons:</h2>
      <a target="_blank" href="https://addons.mozilla.org/en-US/firefox/addon/xr-graph-browser-integration/" class="button">Get Firefox Addon</a>
      <a target="_blank" href="https://chrome.google.com/webstore/detail/xr-graph-browser-integrat/mkapnmjibodohclhpalpcohdibinijfi?hl=en" class="button">Get Chrome Addon</a>

      <h2>Support</h2>
      <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Support Me on Ko-fi', '#29abe0', 'Q5Q71M4SL');kofiwidget2.draw();</script> 
    </div>
  </div>
  <div class="enter-ar">
    <button class="enter-ar-button" id="enter-ar"></button>
  </div>
  <a-scene shadow="type: pcfsoft"  cursor="rayOrigin:mouse" physics="driver: local; debug: true; gravity: 0; friction: 0; restitution: 0;" renderer="antialias: true" cursor="rayOrigin: mouse" raycaster="objects: [my-slider]">
    <a-assets>
      <a-mixin id="touch" class="hands" ></a-mixin>
    </a-assets>

    <!-- <a-sky color="#444"></a-sky> -->
    <a-entity class="environment" environment="groundTexture: none; grid: 1x1; gridColor: #222; ground: flat; lighting: none; skyType: color; skyColor: #222; fog: 0.97; horizonColor: #222; groundColor: #333; groundColor2: #fff"></a-entity>

      <a-entity data-aabb-collider-dynamic="true" class="grabbable" id="plot" scale="0.5 0.5 0.5" position="0 1 -0.6" graph="uMin: -6.2; uMax: 6.2; vMin: -6.2; vMax: 6.2; showBoundingBox: true; showBoundingLabels: false; showWireframe: false; function: f(u,v) = [u, v, a * cos(v) + b * sin(u)]"></a-entity >
      
      <a-entity visible="false" data-aabb-collider-dynamic="true" class="grabbable visible-on-vr" position="-0.6 1 0" rotation="0 70 0" graph-parameter-ui="graph: #plot"></a-entity>
      <a-entity visible="false" data-aabb-collider-dynamic="true" class="grabbable visible-on-vr" position="0.6 1 0" rotation="0 -70 0" graph-variable-ui="graph: #plot"></a-entity>
      
      <a-entity position="0.7 1 0.4" rotation="0 -90 0" data-aabb-collider-dynamic="true" class="grabbable visible-on-vr" visible="false">
        <a-entity my-toggle="title: bounding box; active: true" event-set__active="_target: #plot; graph.showBoundingBox: true" event-set__inactive="_target: #plot; graph.showBoundingBox: false" position="0 0 0"></a-entity>
        <a-entity my-toggle="title: labels; active: false" event-set__active="_target: #plot; graph.showBoundingLabels: true" event-set__inactive="_target: #plot; graph.showBoundingLabels: false" position="0 0.2 0"></a-entity>
        <a-entity my-toggle="title: wireframe; active: false" event-set__active="_target: #plot; graph.showWireframe: true" event-set__inactive="_target: #plot; graph.showWireframe: false" position="0.25 0 0"></a-entity>
        <a-entity my-toggle="title: grid; active: false" event-set__active="_target: #plot; graph.showGrid: true" event-set__inactive="_target: #plot; graph.showGrid: false" position="0.25 0.2 0"></a-entity>
      </a-entity>

      <a-entity id="function-text" position="0 0.01 -0.3" rotation="-90 0 0" scale="1.2 1.2 1.2" my-text="text: ; color: #777"></a-entity>

      <a-entity light="type: spot; color: #ffffff; intensity: 0.9; castShadow: false" position="0 2 0" rotation="-90 0 0"></a-entity>
      <a-entity light="type: ambient; color: #ffffff; intensity: 0.6;" position="0 3 0"></a-entity>

      <!-- <a-entity position="0 1.2 -0.3" fps-counter="for90fps: false"></a-entity> -->

    <!-- <a-log rotation="0 45 0" position="-2 0 -1"></a-log> -->

    <a-entity interaction-hands aabb-collider="objects: .grabbable" id="lhand" hand-controls="hand: left; handModelStyle: highPoly" mixin="touch"></a-entity>
    <a-entity interaction-hands aabb-collider="objects: .grabbable" id="rhand" hand-controls="hand: right; handModelStyle: highPoly" mixin="touch"></a-entity>

    <a-entity camera  orbit-controls="target: 0 1 -0.6; initialPosition: -0.5 1.4 0.3; minDistance: -0.01"></a-entity>
  </a-scene>
</body>
<script>

  const scene = document.querySelector('a-scene');
  const vrElements = document.querySelectorAll(".visible-on-vr");
  const environment = document.querySelector(".environment");
  console.log(environment);
  scene.addEventListener("enter-vr", () => {
    vrElements.forEach((el) => {
      el.setAttribute("visible", "true")
    });
    if (scene.is('ar-mode')) {
      environment.setAttribute("visible", "false")
    }
  })
  scene.addEventListener("exit-vr", () => {
    vrElements.forEach((el) => {
      el.setAttribute("visible", "false")
    });
    environment.setAttribute("visible", "true")
  })

  const plot = document.querySelector("#plot");
  const textEl = document.querySelector("#function-text");
  const graph = plot.components["graph"];

  plot.addEventListener('function-changed', (evt) => {    
    textEl.setAttribute('my-text', {
      text: evt.detail.function
    })
  })

  textEl.setAttribute('my-text', {
    text: plot.components["graph"].data.function
  })

  function findGetParameter(parameterName) {
    var result = null,
        tmp = [];
    location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        });
    return result;
  }

  function cleanString(input) {
      var output = "";
      for (var i=0; i<input.length; i++) {
          if (input.charAt(i) == '‑') {
            output += '-'
          } else if (input.charCodeAt(i) <= 127) {
              output += input.charAt(i);
          }
      }
      return output;
  }
  
  const getAllGetParameters = () => {
    parameters = {};
    location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          parameters[tmp[0]] = cleanString(decodeURIComponent(tmp[1]));
        });
    return parameters
  }

  plot.setAttribute('graph', getAllGetParameters());

  document.querySelector('.function-input').value = plot.components["graph"].data.function;
  document.querySelector('.update-button').addEventListener('click', () => {
    window.location.href = '?function=' + encodeURIComponent(document.querySelector('.function-input').value);
  })

  document.querySelector('.menu-icon').addEventListener('click', () => {
    document.querySelector('.menu').classList.toggle('closed');
  })

  // function checkARSupport() {
  //   if (navigator.xr == null) {
  //     return false;
  //   }
  //   if (navigator.xr.supportsSession == null) {
  //     return false;
  //   }
  //   // Check to see if the UA can support an AR sessions.
  //   return navigator.xr.supportsSession('immersive-ar')
  //       .then(() => { console.log("AR content is supported!"); })
  //       .catch((reason) => { console.log("AR content is not supported: " + reason); });
  // }

  // if(checkARSupport()) {
  //   document.querySelector(".enter-ar").style.display = "none";
  // }

  document.querySelector(".enter-ar").addEventListener("click", () => {
    let params = Object.entries(plot.getAttribute("graph")).map(([key, val]) => `${key}=${encodeURIComponent(val)}`).join('&');
    window.location.href = 'ar.html?' + params;
  });

  // var a = 1;

  // setInterval(() => {
  //   plot.setAttribute("graph", {
  //     a: a
  //   })
  //   a += 0.001;
  // }, 1);

</script>
</html>